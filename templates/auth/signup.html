<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Basic Page Needs
    ================================================== -->
  <meta charset="utf-8">
  <!--[if IE]><meta http-equiv="x-ua-compatible" content="IE=9" /><![endif]-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NewsUp - News, Magazine and Article Directory Theme</title>
  <meta name="description" content="NewsUp is a multi-page oriented template perfect for NewsUp - News, Magazine, Blogging and Article Directory.">
  <meta name="keywords" content="news theme, magazine, blog, article directory, article submission, writer, author, publication, html, bootstrap">
  <meta name="author" content="Sempy Themes">

  <!-- Favicons
        ================================================== -->
  <link rel="shortcut icon" href="/static/newsup/img/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/static/newsup/img/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/static/newsup/img/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/static/newsup/img/apple-touch-icon-114x114.png">

  <!-- Bootstrap
        ================================================== -->
  <link href="{{ static_url('newsup/css/bootstrap.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('newsup/css/bootstrap-tagsinput.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('newsup/css/jasny-bootstrap.min.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('css/font-awesome.min.css') }}" rel="stylesheet" type="text/css" />

  <!-- Animate
        ================================================== -->
  <link href="{{ static_url('newsup/css/effect2.css') }}" rel='stylesheet' type='text/css' />
  <link href="{{ static_url('newsup/css/animate.css') }}" rel='stylesheet' type='text/css' />

  <!-- Add fancyBox CSS files -->
  <link href="{{ static_url('newsup/js/fancybox/jquery.fancybox.css') }}" media="screen" rel="stylesheet" type="text/css" />

  <!-- Owl Slider CSS -->
  <link href="{{ static_url('newsup/css/owl.carousel.css') }}" media="screen" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('newsup/css/owl.theme.css') }}" media="screen" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('newsup/css/owl.transitions.css') }}" media="screen" rel="stylesheet" type="text/css" />

  <!-- Custom Css
        ================================================== -->
  <link href="{{ static_url('newsup/css/rs-wp-v1.2.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('newsup/css/jquery.rs.selectbox.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('css/style.css') }}" rel="stylesheet" type="text/css" />
  <link href="{{ static_url('css/self.css') }}" rel="stylesheet" type="text/css" />
  <!--
  <link href="{{ static_url('css/login.css') }}" rel="stylesheet" type="text/css" />
  -->
  <link href="{{ static_url('newsup/css/responsive.css') }}" rel="stylesheet" type="text/css" />

  <!-- Custom Fonts
        ================================================== -->
  <link href="{{ static_url('newsup/fonts/stylesheet.css') }}" rel="stylesheet" type="text/css" />

  <!-- Google Fonts
        ================================================== -->
  <link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script type="text/javascript" src="{{ static_url('newsup/js/jquery.1.11.1.js') }}"></script>

</head>

<body>

  <!--- Wrapper -->
  <section id="wrapper" class="clearfix">

    <!--- Header -->
    <header>

      <!-- socialbar -->
      {% module Template("newsup/block-socialbar.html", is_login=is_login) %}
      <!-- /socialbar -->

      <!-- menubar -->
      {% module Template("newsup/block-menubar.html") %}
      <!-- /menubar -->

    </header>
    <!--- End Header -->

    <!-- Page Breadcrumb -->
    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <div class="rst-breadcrumb">
            <a href="/portal/newsup/index"><span>首页</span></a>
            <span>></span>
            <a href="/portal/newsup/register"><span>注册</span></a>
          </div>
        </div>
      </div>
    </div>
    <!-- End Page Breadcrumb -->

    <!-- Section Register -->
    <section id="rst-register-page">
      <div class="container">
        <div class="row">
          <div class="col-sm-4">
            <form id="register-form" onsubmit="return false;">
              <div class="rst-section-title rst-section-title-box">
                <h4>注册新用户</h4>
              </div>
              <!-- end section title -->
              <div class="form-group">
                <label for="rg_phone" class="sr-only">Phone</label>
                <input id="rg_phone" name="rg_phone" class="rst-pageinput" type="text" placeholder="手机号码" />
              </div>
              <div class="form-group">
                <label for="rg_pwd" class="sr-only">Password</label>
                <input id="rg_pwd" name="rg_pwd" class="rst-pageinput" type="password" placeholder="密码" />
              </div>
              <div class="register-form-main-message"></div>
              <button class="rst-pagebutton" type="submit">注册</button>
            </form>
          </div>

          <div class="col-sm-4">
            <form id="login-form" onsubmit="return false;">
              <div class="rst-section-title rst-section-title-box">
                <h4>登录</h4>
              </div>

              <!-- end section title -->
              <div class="form-group">
                <label for="lg_phone" class="sr-only">Phone</label>
                <input id="lg_phone" name="lg_phone" class="rst-pageinput" type="text" placeholder="手机号码" />
              </div>
              <div class="form-group">
                <label for="lg_pwd" class="sr-only">Password</label>
                <input id="lg_pwd" name="lg_pwd" class="rst-pageinput" type="password" placeholder="密码" />
              </div>
              <div class="login-form-main-message"></div>
              <button class="rst-pagebutton" type="submit">登录</button>
            </form>
          </div>

          <div class="col-sm-4">
            <form id="lostpwd-form" onsubmit="return false;">
              <div class="rst-section-title rst-section-title-box">
                <h4>找回密码</h4>
              </div>

              <!-- end section title -->
              <div class="form-group">
                <label for="lp_phone" class="sr-only">Phone</label>
                <input id="lp_phone" name="lp_phone" class="rst-pageinput" type="text" placeholder="手机号码" />
              </div>
              <div class="form-group" style="position:relative;">
                <label for="lp_verify_code" class="sr-only">Phone</label>
                <input id="lp_verify_code" name="lp_verify_code" class="rst-pageinput" type="text" placeholder="验证码" />
                <input type="button" onclick="SmsVerifyCode();" id="code-button" class="rst-pagebutton" value="获取验证码"></button>
              </div>
              <div class="lostpwd-verify-code-message"></div>
              <div class="form-group">
                <label for="lp_pwd" class="sr-only">Password</label>
                <input id="lp_pwd" name="lp_pwd" class="rst-pageinput" type="password" placeholder="新密码" />
              </div>
              <div class="lostpwd-form-main-message"></div>
              <button class="rst-pagebutton" type="submit">确定 </button>
            </form>
          </div>
        </div>
      </div>
    </section>
    <!-- End Section Register -->

    <!-- Footer -->
    {% module Template("newsup/block-footer.html") %}
    <!-- End Footer -->

  </section>
  <!--- End Wrapper -->


  <!-- Bootstrap Js Compiled Plugins -->
  <script type="text/javascript" src="{{ static_url('newsup/js/bootstrap.min.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('newsup/js/bootstrap-tagsinput.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('newsup/js/jqBootstrapValidation.js') }}"></script>

  <!-- WoW Js -->
  <script type="text/javascript" src="{{ static_url('newsup/js/wow.min.js') }}"></script>

  <!-- Add Fancybox -->
  <script type="text/javascript" src="{{ static_url('newsup/js/fancybox/jquery.fancybox.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('newsup/js/fancybox/helpers/jquery.fancybox-media.js') }}"></script>

  <!-- Owl Slider Js -->
  <script type="text/javascript" src="{{ static_url('newsup/js/owl.carousel.js') }}"></script>

  <!-- Weather Js -->
  <!--
  <script type="text/javascript" src="{{ static_url('newsup/js/jquery.simpleWeather.js') }}"></script>
  -->

  <!-- Custome Selectbox Js -->
  <script type="text/javascript" src="{{ static_url('newsup/js/jquery.rs.selectbox.js') }}"></script>

  <script type="text/javascript" src="{{ static_url('js/main.js') }}"></script>

  <!-- login -->
  <script type="text/javascript" src="{{ static_url('js/md5.min.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('js/json2.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('js/jquery.validate.min.js') }}"></script>

  <script type="text/javascript">
    function SmsVerifyCode() {
      var wait = 300; // 5分钟
      function time(t) {
        if (wait == 0) {
          t.removeAttribute("disabled");
          t.value = "获取验证码";
          wait = 300; // 5分钟
        } else {
          t.setAttribute("disabled", true);
          t.value = "" + wait + "秒";
          wait--;
          setTimeout(function() {
            time(t)
          }, 1000)
        }
      }

      var validator = $("#lostpwd-form").validate();
      if (validator.element("#lp_phone")) {
        var phone = $("#lp_phone").val();
        console.log(phone);
        var data = {
          "action": "lost-pwd",
          "login_type": "phone",
          "phone": phone,
        };
        var json = JSON.stringify(data);
        console.log(json);

        $.ajax({
          type: "POST",
          url: "/api/auth/verify-codes", //  http://api.7x24hs.com
          headers: {
            "Authorization": "Bearer eHfWk+OqSWaR7FhDTkW/d7TIZqP3q0W3nVGXKZY5A8Q="
          },
          data: json,
          dataType: "json",
          contentType: 'application/json',
          success: function(data, status, xhr) {
            var btn = document.getElementById("code-button");
            time(btn);
            $('.lostpwd-verify-code-message').addClass('show error').html("验证码已通过短信发出, 注意查收! 5分钟内有效。");
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
            if (XMLHttpRequest.status == 200) {
              var btn = document.getElementById("code-button");
              time(btn);
              $('.lostpwd-verify-code-message').addClass('show error').html("验证码已通过短信发出, 注意查收! 5分钟内有效。");
            } else if (XMLHttpRequest.status == 401) {
              $('.lostpwd-verify-code-message').addClass('show error').html("验证码不正确!");
            } else if (XMLHttpRequest.status == 404) {
              $('.lostpwd-verify-code-message').addClass('show error').html("此手机号码未注册!");
            } else if (XMLHttpRequest.status == 202) {
              $('.lostpwd-verify-code-message').addClass('show error').html("短信验证码5分钟内有效, 不必获取新的!");
            } else {
              $('.lostpwd-verify-code-message').addClass('show error').html(XMLHttpRequest.status + ": 服务器异常,请稍后重试!");
            }
          },
          complete: function(XMLHttpRequest, textStatus) {
            this; // 调用本次AJAX请求时传递的options参数
          }
        });
      } else {
        return false;
      }
    }


    $(function() {
      // 手机号码验证
      jQuery.validator.addMethod("mobile", function(value, element) {
        var length = value.length;
        var mobile = /^(((13[0-9]{1})|(15[0-9]{1})|(17[0-9]{1})|(18[0-9]{1})|(19[0-9]{1}))+\d{8})$/;
        return this.optional(element) || (length == 11 && mobile.test(value));
      }, "请正确填写您的手机号码");


      // 验证码
      jQuery.validator.addMethod("code", function(value, element) {
        var length = value.length;
        var code = /^[0-9]{4}$/;
        return this.optional(element) || (length == 4 && code.test(value));
      }, "请正确填写验证码");


      // Login Form
      //----------------------------------------------
      // Validation
      $("#login-form").validate({
        rules: {
          lg_phone: {
            minlength: 11,
            maxlength: 11,
            required: true,
            mobile: true
          },
          lg_pwd: {
            required: true,
          },
        },
        messages:{
          lg_phone:"请输入正确的手机号码！",
          lg_pwd:{
            required: "请输入密码",
          }
        },
        errorClass: "error",
        submitHandler: function(form) {
          console.log('login');

          var data = {
            action: 'login',
            login_type: 'phone',
            phone: $('#lg_phone').val(),
            pwd: $.md5($('#lg_pwd').val()),
          };
          var json = JSON.stringify(data);
          console.log(json);

          $.ajax({
            type: "POST",
            url: "/api/auth/tokens",
            headers: {
              "Authorization": "Bearer eHfWk+OqSWaR7FhDTkW/d7TIZqP3q0W3nVGXKZY5A8Q="
            },
            data: json,
            dataType: "json",
            contentType: 'application/json',
            success: function(data, status, xhr) {
              var json = JSON.stringify(data);
              console.log(json);

              // 登录成功后，注册入联盟
              $.ajax({
                type: "POST",
                url: "/portal/auth/league-signup",
                data: json,
                dataType: "json",
                contentType: 'application/json',
                success: function(data, status, xhr) {},
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                  console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
                },
                complete: function(XMLHttpRequest, textStatus) {
                  this; // 调用本次AJAX请求时传递的options参数
                }
              });

              location.href = "/portal/newsup/login-next";
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              if (XMLHttpRequest.status == 404) {
                $('.login-form-main-message').addClass('show error').html('手机号码或密码不正确, 请重试');
              }
            },
            complete: function(XMLHttpRequest, textStatus) {
              this; // 调用本次AJAX请求时传递的options参数
            }
          });
        }
      });


      // Register Form
      //----------------------------------------------
      // Validation
      $("#register-form").validate({
        rules: {
          rg_phone: {
            minlength: 11,
            maxlength: 11,
            required: true,
            mobile: true,
          },
          rg_pwd: {
            required: true,
            minlength: 6
          },
        },
        messages: {
         rg_phone: "请输入正确的手机号",
         rg_pwd: {
          required: "请输入密码",
          minlength:"输入至少6位密码"
         }
        },
        errorClass: "error",
        submitHandler: function(form) {
          console.log('register');
          var data = {
            action: 'register',
            login_type: 'phone',
            phone: $('#rg_phone').val(),
            pwd: $.md5($('#rg_pwd').val()),
          };
          var json = JSON.stringify(data);
          console.log(json);

          $.ajax({
            type: "POST",
            url: "/api/auth/accounts",
            headers: {
              "Authorization": "Bearer eHfWk+OqSWaR7FhDTkW/d7TIZqP3q0W3nVGXKZY5A8Q="
            },
            data: json,
            dataType: "json",
            contentType: 'application/json',
            success: function(data, status, xhr) {
              var json = JSON.stringify(data);
              console.log(json);

              // 注册帐号成功后，登录
              $.ajax({
                type: "POST",
                url: "/api/auth/tokens",
                headers: {
                  "Authorization": "Bearer eHfWk+OqSWaR7FhDTkW/d7TIZqP3q0W3nVGXKZY5A8Q="
                },
                data: json,
                dataType: "json",
                contentType: 'application/json',
                success: function(data, status, xhr) {
                  var json = JSON.stringify(data);
                  console.log(json);

                  // 登录成功后，加入联盟
                  $.ajax({
                    type: "POST",
                    url: "/portal/auth/league-signup",
                    data: json,
                    dataType: "json",
                    contentType: 'application/json',
                    success: function(data, status, xhr) {},
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                      console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
                    },
                    complete: function(XMLHttpRequest, textStatus) {
                      this; // 调用本次AJAX请求时传递的options参数
                    }
                  });
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                  console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
                },
                complete: function(XMLHttpRequest, textStatus) {
                  this; // 调用本次AJAX请求时传递的options参数
                }
              });

              location.href = "/portal/newsup/login-next";
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              if (XMLHttpRequest.status == 409) {
                $('.register-form-main-message').addClass('show error').html('帐号已经存在, 请更换手机号码');
              } else {
                $('.register-form-main-message').addClass('show error').html('网络异常,刷新重试');
              }
            },
            complete: function(XMLHttpRequest, textStatus) {
              this; // 调用本次AJAX请求时传递的options参数
            }
          });
        }
      });


      // Lost password Form
      //----------------------------------------------
      // Validation
      $("#lostpwd-form").validate({
        rules: {
          lp_phone: {
            minlength: 11,
            maxlength: 11,
            required: true,
            mobile: true
          },
          lp_verify_code: {
            required: true,
            minlength: 4,
            maxlength: 4,
            code: true
          },
          lp_pwd: {
            required: true,
            minlength: 6
          },
        },
        messages:{
          lp_phone:"请输入正确的手机号码！",
          lp_verify_code: {
            required: "请输入验证码！",
            minlength: "验证码至少4位",
          },
          lp_pwd:{
            required: "请输入密码！",
            minlength: "密码长度至少6位"
          },
        },
        errorClass: "error",
        submitHandler: function(form) {
          var data = {
            action: 'reset-pwd',
            login_type: 'phone',
            phone: $('#lp_phone').val(),
            verify_code: $('#lp_verify_code').val(),
            pwd: $.md5($('#lp_pwd').val()),
          };
          var json = JSON.stringify(data);
          console.log(json);

          $.ajax({
            type: "PUT",
            url: "/api/auth/pwds",
            headers: {
              "Authorization": "Bearer eHfWk+OqSWaR7FhDTkW/d7TIZqP3q0W3nVGXKZY5A8Q="
            },
            data: json,
            dataType: "json",
            contentType: 'application/json',
            success: function(data, status, xhr) {
              console.log(data);
              $('.lostpwd-form-main-message').addClass('show error').html('密码已经重置，请重新登录!');
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              console.log("XMLHttpRequest.status: " + XMLHttpRequest.status);
              if (XMLHttpRequest.status == 200) {
                $('.lostpwd-form-main-message').addClass('show error').html('密码已经重置，请重新登录!');
              } else if (XMLHttpRequest.status == 408) {
                $('.lostpwd-form-main-message').addClass('show error').html('验证码已经超时, 请重新申请');
              } else {
                $('.lostpwd-form-main-message').addClass('show error').html('网络异常,刷新重试');
              }
            },
            complete: function(XMLHttpRequest, textStatus) {
              this; // 调用本次AJAX请求时传递的options参数
            }
          });
        }
      });

    });
  </script>

</body>

</html>
