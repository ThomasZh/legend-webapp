<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <title>Shuttle - Material Design Mobile Template</title>
    <meta name="description" content="Material Design Mobile Template">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/static/shuttle/img/touch/apple-touch-icon-144x144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/shuttle/img/touch/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/shuttle/img/touch/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/static/shuttle/img/touch/apple-touch-icon-57x57-precomposed.png">
    <link rel="shortcut icon" sizes="196x196" href="/static/shuttle/img/touch/touch-icon-196x196.png">
    <link rel="shortcut icon" href="/static/shuttle/img/touch/apple-touch-icon.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/static/shuttle/img/touch/apple-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#222222">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- SEO: If mobile URL is different from desktop URL, add a canonical link to the desktop page -->
    <!--
    <link rel="canonical" href="http://www.example.com/" >
    -->

    <!-- For iOS web apps. Delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
    <!--
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="">
    -->

    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,100' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <!-- Icons -->
    <link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" media="all" rel="stylesheet" type="text/css">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ static_url('shuttle/css/animate.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/materialize.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swipebox.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swiper.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/main.css') }}">
    <link rel="stylesheet" href="{{ static_url('weui/lib/weui.min.css') }}">

  </head>

  <body>

    <!-- Main Container -->
    <div id="mainContainer" class="main">

      <!-- Toolbar -->
      {% module Template("shuttle/block-toolbar.html") %}
      <!-- End of Toolbar -->

      <!-- Page Contents -->
      <div class="page animated fadeinup">
        <!-- Hero Header -->
        <div class="hero-header hero-big bg-3 animated fadeindown">
          <div class="hero-author">
            <div class="media-top-object">
              <div class="media-body left-align">
                <span class="white-text small"><em>Freelancer @Envato</em></span>
                <div class="card-feedback">
                  <div class="card-users white-text">
                    <i class="ion-ios-heart accent-text"></i> <span>346</span>
                    <i class="ion-android-person-add"></i> <span>205</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="opacity-overlay-gradient"></div>
        </div>

        <!-- moment -->
        <div id="moment-form">
          <ul class="">
            <li
              is="oneMoment"
              v-for="(moment, idx) in moments"
              v-bind:moment="moment"
              v-bind:idx="idx"
            ></li>
            <li style="text-align:center" id="getMoreBtn"><a v-on:click="getMore">加载更多</a></li>
          </ul>

        </div>

        <!-- footer -->
        {% module Template("shuttle/block-footer.html") %}
        <!-- /footer -->

      </div>
      <!-- End of Page Contents -->

      <div class="fixed-action-btn">
        <a class="btn-floating btn-large waves-effect waves-light accent-color modal-trigger"
           href="/webapp/clubs/{{ club_id }}/add-moment">
          <i class="ion-android-add"></i></a>
      </div>

      <!-- Sidebars -->
      <!-- left sidebar -->
      {% module Template("shuttle/block-left-sidebar.html") %}
      <!-- /left sidebar -->

      <!-- right sidebar -->
      {% module Template("shuttle/block-right-sidebar.html") %}
      <!-- /right sidebar -->
      <!-- End of Sidebars -->

    </div>
    <!-- End of Main Container -->

    <!-- Scripts -->
    <script src="{{ static_url('shuttle/js/vendor/jquery-2.1.0.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/helper.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/HeadsUp.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.smoothState.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/chart.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.mixitup.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.swipebox.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/masonry.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/swiper.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/materialize.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/main.js') }}"></script>

    <!-- fileinput -->
  	<script src="{{ static_url("upyun/js/spark-md5.min.js") }}"></script>
  	<script src="{{ static_url("upyun/js/async.js") }}"></script>
  	<script src="{{ static_url("upyun/js/upyun-mu.js") }}"></script>

    <!-- customer js files -->
    <script src='{{ static_url("js/exif.js") }}' type="text/javascript"></script>
    <script src='{{ static_url("js/mobileBUGFix.mini.js") }}' type="text/javascript"></script>
    <script src='{{ static_url("js/json2.js") }}' type='text/javascript'></script>
    <script src="{{ static_url('js/vue-2.1.4.js') }}" type="text/javascript"></script>

    <script>
      Vue.component('oneImage', {
        template: '\
          <div class="grid-item">\
            <a v-bind:href="imageUrl" class="swipebox no-smoothState" title="">\
              <img v-bind:src="imageUrl" alt="image">\
            </a>\
          </div>\
        ',
        props: ['idx','imageUrl'],
      })

      Vue.component('oneComment', {
        template: '\
          <div class="media-top-object animated delay-3">\
            <img v-bind:src="comment.avatar" alt="" class="media-left avatar">\
            <div class="media-body">\
              <span>{{! comment.nickname }}</span>\
              <span class="small">{{! comment.comment }}</span>\
            </div>\
          </div>\
        ',
        props: ['idx','comment'],
        methods: {
        }
      })

      Vue.component('oneMoment', {
        template: '\
        <div class="card fullscreen">\
          <div class="p-20">\
            <div class="grid m-t-20">\
              <div is="oneImage"\
                v-for="(imageUrl, idx) in moment.imgs"\
                v-bind:imageUrl="imageUrl"\
                v-bind:idx="idx"\
              ></div>\
            </div>\
          </div>\
          <div class="card-feedback">\
            <div class="card-users" v-if="moment.zan==true">\
              <i class="ion-eye"></i> <span>{{! moment.view_num  }}</span>\
              <i id="like-icon" class="ion-ios-heart accent-text"></i> <span>{{! moment.like_num }}</span>\
              <i class="ion-chatbubble-working"></i> <span>{{! moment.comment_num }}</span>\
            </div>\
            <div class="card-users" v-if="moment.zan==false">\
              <i class="ion-eye"></i> <span>{{! moment.view_num  }}</span>\
              <i id="like-icon" v-on:click="onLike(idx)" class="ion-ios-heart-outline accent-text"></i> <span>{{! moment.like_num }}</span>\
              <i class="ion-chatbubble-working"></i> <span>{{! moment.comment_num }}</span>\
            </div>\
          </div>\
          <div class="card-content">\
            <h5><strong>{{! moment.subtitle }}</strong></h5>\
          </div>\
          <div class="card-author">\
            <div class="media-top-object middle">\
              <img v-bind:src="moment.avatar" alt="" class="media-left avatar small">\
              <div class="media-body">\
                <span class="small">{{! moment.nickname }}\
                <a href="#!" class="accent-text">\
                  &nbsp;{{! moment.friendlyTime }}</a>\
                </span>\
              </div>\
            </div>\
          </div>\
          <div class="comments grey lighten-4">\
            <h5>{{! moment.comment_num }} 条评论</h5>\
            <div is="oneComment"\
              v-for="(comment, idx) in moment.resComments"\
              v-bind:comment="comment"\
              v-bind:idx="idx"\
            ></div>\
            <div class="controls right-align animated fadeinup delay-2">\
              <textarea class="materialize-textarea" v-bind:id="idx" \
                placeholder="Write your comment here"></textarea>\
              <button class="left"  v-bind:id="idx" v-on:click="addComment(idx)">发评论</button>\
              <button class="filter" v-bind:id="idx"\
                v-on:click="showComments(idx)" data-filter=".category-3">展开</button>\
            </div>\
           </div>\
         </div>\
        ',
        props: ['idx','moment'],
        methods: {
          onLike: function(idx) {

            var moments = this.$parent.moments;
            // console.log(moments);
            var moment = moments[idx];
            var momentId = moment._id;

            moment.zan = true;
            moment.like_num += 1;

            $.ajax({
              type: "POST",
              url: "/api/moments/"+momentId+"/like",
              data: "",
              dataType: "json",
              contentType: 'application/json',
              success: function(data, status, xhr) {
                // moment.zan = true;
                // moment.like_num += 1;
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                // $.alert(XMLHttpRequest.status + ": 操作失败!");
                if (XMLHttpRequest.status == 200) {
                  // moment.zan = true;
                  // moment.like_num += 1;
                  // $.alert("error:200");
                } else if (XMLHttpRequest.status == 404) {
                  // $.alert("error:404");
                }else{
                  $.alert("error: "+XMLHttpRequest.status);
                }
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },

          addComment: function(idx) {
            var moments = this.$parent.moments;
            // console.log(moments);
            var moment = moments[idx];
            var momentId = moment._id;

            var str = $('#'+idx).val();
            // alert(str);
            if(str == null || str == "" || str.length == 0){
              $('#'+idx).focus();
              return;
            }

            var data = {
              "comment": str,
            };
            var json = JSON.stringify(data);
            console.log(json);

            $.ajax({
              type: "POST",
              url: "/api/moments/"+momentId+"/comment",
              data: json,
              dataType: "json",
              contentType: 'application/json',
              success: function(data, status, xhr) {
                console.log(data);
                moment.comment_num += 1;
                moment.resComments.splice(0,0,data)
                $('#'+idx).val("");
                // _self.queryNewComment(idx);
                // comment = {'avatar':data.avatar,'comment':data.comment,'nickname':data.nickname}
                // moment.resComments.splice(0,0,comment);
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                // $.alert(XMLHttpRequest.status + ": 操作失败!");
                if (XMLHttpRequest.status == 200) {
                  moment.comment_num += 1;
                  moment.resComments.splice(0,0,data)
                  $('#'+idx).val("")
                  // $.alert("error:200");
                } else if (XMLHttpRequest.status == 404) {
                  // $.alert("error:404");
                }else{
                  // $.alert("error: "+XMLHttpRequest.status);
                }
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },

          showComments: function(idx){
            var _self = this;
            _self.queryComments(idx,3);
          },

          queryComments: function(idx, limit) {
            var _self = this;
            var moments = this.$parent.moments;
            // console.log(moments);
            var moment = moments[idx];
            var momentId = moment._id;
            // 记录一个moment的comments当前的加载位置
            var comment_idx = moment.resComments.length;

            // $("#loadMoreBtn").text('Loading...');
            // $("#"+idx).text('Loading...');
            $.ajax({
              type: "GET",
              url: "/api/moments/"+momentId+"/comment?idx=" + comment_idx + "&limit=" + limit,
              async: false,
              dataType: "json",
              contentType: 'application/json',
              success: function(datas, status, xhr) {
                console.log(datas);
                for(var i = 0, l = datas.length; i < l; i++) {
                  moment.resComments.push(datas[i]);
                }
                // $("#loadMoreBtn").text('更多...');
                // $("#"+idx).text('更多...');

                if(datas.length < limit || datas.length == 0){
                  // $("#loadMoreBtn").text('没了！');
                  // $("#"+idx).text('没了！');
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },

        }
      })

      new Vue({
       el: '#moment-form',
       data: {
         moments: [],
         moment_num: 0,
         limit: 5
       },
       created: function () {
          this.queryMoments(0,this.limit);
          setTimeout(function(){
            // Masonry
            $('.grid').masonry({
              itemSelector: '.grid-item'
            });
          },100);
       },
       updated: function(){
         console.log("===============updated");
         setTimeout(function(){
           // Masonry
           $('.grid').masonry({
             itemSelector: '.grid-item'
           });
         },100);
       },
       methods: {
         getMore: function() {
           var _self = this;
           $("#getMoreBtn").text('Loading...');
           _self.queryMoments(_self.moment_num, _self.limit);
           setTimeout(function(){
             if (_self.comment_num % _self.limit == 0){
               $("#getMoreBtn").text('More moments');
             } else {
               $("#getMoreBtn").css('display','none');
             }
           }, 1000);
         },

         queryMoments: function(idx,limit) {
           _self = this;
          // http://api.7x24hs.com/api/moments
           $.ajax({
             type: "GET",
             url: "/api/moments?idx=" + idx + "&limit=" + limit+"&filter=club&club_id={{ club_id }}",
             async: false,
             dataType: "json",
             contentType: 'application/json',
             success: function(datas, status, xhr) {
               for(var i = 0, l = datas.length; i < l; i++) {
                 datas[i].resComments = [];
                 datas[i].zan = false;
                 datas[i].friendlyTime =_self.getFriendlyTime(datas[i].create_time);
                 _self.moments.push(datas[i]);
                 _self.moment_num += 1;
               }
               if(datas.length < limit){
                 $("#getMoreBtn").css('display','none');
               }
             },
             error: function(XMLHttpRequest, textStatus, errorThrown) {
               console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
             },
             complete: function(XMLHttpRequest, textStatus) {
               this; // 调用本次AJAX请求时传递的options参数
             }
           });
         },

         getFriendlyTime(nS) { //时间戳转换
              console.log(nS);
              return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');
          },
       }
     })
   </script>

  </body>
</html>
