<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <title>Shuttle - Material Design Mobile Template</title>
    <meta name="description" content="Material Design Mobile Template">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/static/shuttle/img/touch/apple-touch-icon-144x144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/shuttle/img/touch/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/shuttle/img/touch/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/static/shuttle/img/touch/apple-touch-icon-57x57-precomposed.png">
    <link rel="shortcut icon" sizes="196x196" href="/static/shuttle/img/touch/touch-icon-196x196.png">
    <link rel="shortcut icon" href="/static/shuttle/img/touch/apple-touch-icon.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="/static/shuttle/img/touch/apple-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#222222">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- SEO: If mobile URL is different from desktop URL, add a canonical link to the desktop page -->
    <!--
    <link rel="canonical" href="http://www.example.com/" >
    -->

    <!-- For iOS web apps. Delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
    <!--
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="">
    -->

    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,100' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
    <!-- Icons -->
    <link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" media="all" rel="stylesheet" type="text/css">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ static_url('shuttle/css/animate.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/materialize.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swipebox.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/swiper.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ static_url('shuttle/css/main.css') }}">
    <link rel="stylesheet" href="{{ static_url('weui/lib/weui.min.css') }}">
  </head>

  <body>

    <!-- Main Container -->
    <div id="main" class="main">

      <!-- Toolbar -->
      {% module Template("shuttle/block-toolbar.html") %}
      <!-- End of Toolbar -->

      <!-- Page Contents -->
      <div class="page animated fadeinup">

        <!-- Hero Header -->
        <div class="hero-header hero-big bg-3 animated fadeindown">
          <div class="hero-author">
            <div class="media-top-object">
              <div class="media-body left-align">
                <span class="white-text small"><em>Freelancer @Envato</em></span>
                <div class="card-feedback">
                  <div class="card-users white-text">
                    <i class="ion-ios-heart accent-text"></i> <span>346</span>
                    <i class="ion-android-person-add"></i> <span>205</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="opacity-overlay-gradient"></div>
        </div>

        {% for moment in moments %}
        <div class="card fullscreen">
          <!-- Contents -->
          <div class="p-20">
            <div class="grid m-t-20">
              {% for img in moment['imgs'] %}
              <div class="grid-item">
                <a href="{{ img }}" class="swipebox no-smoothState" title="">
                  <img src="{{ img }}!700x467" alt="image">
                </a>
              </div>
              {% end %}
            </div>
          </div>

          <div class="card-feedback">
            <div class="card-users">
              <i class="ion-eye"></i> <span>{{ moment['view_num'] }}</span>
              <a v-on:click="sendLike" class="rst-item-likes">
                <i id="like-icons" class="ion-ios-heart accent-text"></i> <span>{{ moment['like_num'] }}</span>
              </a>
              <i class="ion-chatbubble-working"></i> <span>{{ moment['comment_num'] }}</span>
            </div>
          </div>

          <div class="card-content">
            <h5><strong>
              {% if moment.has_key('subtitle') %}
                {{ moment['subtitle'] }}
              {% end %}
            </strong></h5>
          </div>

          <div class="card-author">
            <div class="media-top-object middle">
              <img src="{{ moment['avatar'] }}!100x100" alt="" class="media-left avatar small">
              <div class="media-body">
                <span class="small">{{ moment['nickname'] }}
                  <a href="#!" class="accent-text">
                    {% for category in moment['categories'] %}
                      #{{ category['title'] }}&nbsp;
                    {% end %}
                  </a></span>
              </div>
            </div>
          </div>

          <!-- Comments -->
          <section id="rst-itemcontent">
          <div class="comments grey lighten-4">
            <h5>{{! comment_num }} Comments</h5>
            <div class="media-top-object animated fadeinright delay-2">

            <ol class="commentlist">
              <li v-for="comment in comments" class="comment">
                <div class="comment-container">
                  <div class="comment-avatar">
                    <img v-bind:src="comment.avatar" alt="" />
                  </div>
                  <div class="comment-data">
                    <div class="comment-header">
                      <a href="#" class="comment-author">{{! comment.nickname }}</a>
                      <time class="comment-date"><i class="fa fa-clock-o"></i>{{! comment.create_time }}</time>
                      <a href="#" class="comment-reply-link">REPLY</a>
                    </div>
                    <div class="comment-body">
                      <p>{{! comment.comment }}</p>
                    </div>
                  </div>
                </div>
              </li>
            </ol>
          </div>


            <!-- <div class="media-top-object animated fadeinright delay-3">
              <img src="/static/shuttle/img/user5.jpg" alt="" class="media-left avatar">
              <div class="media-body">
                <span>Luke Noel</span>
                <span class="small">You have done a great job there :)</span>
              </div>
            </div> -->

            <!-- more comments button -->
            <div class="controls right-align animated fadeinup delay-2">
              <button class="left"  v-on:click="sendComment">Add comment</button>
              <button class="filter" id="loadMoreBtn" v-on:click="loadMore" data-filter=".category-3">More comments...</button>
            </div>
          </div>
          </section>

        </div>
        {% end %}

        <!-- footer -->
        {% module Template("shuttle/block-footer.html") %}
        <!-- /footer -->

      </div>
      <!-- End of Page Contents -->

      <div class="fixed-action-btn">
        <a class="btn-floating btn-large waves-effect waves-light accent-color modal-trigger" href="webapp/demo/add-moment"><i class="ion-android-add"></i></a>
      </div>

      <!-- Sidebars -->
      <!-- left sidebar -->
      {% module Template("shuttle/block-left-sidebar.html") %}
      <!-- /left sidebar -->

      <!-- right sidebar -->
      {% module Template("shuttle/block-right-sidebar.html") %}
      <!-- /right sidebar -->
      <!-- End of Sidebars -->

    </div>
    <!-- End of Main Container -->

    <!-- Scripts -->
    <script src="{{ static_url('shuttle/js/vendor/jquery-2.1.0.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/helper.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/HeadsUp.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.smoothState.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/chart.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.mixitup.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/jquery.swipebox.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/masonry.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/swiper.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/vendor/materialize.min.js') }}"></script>
    <script src="{{ static_url('shuttle/js/main.js') }}"></script>

    <!-- fileinput -->
  	<script src="{{ static_url("upyun/js/spark-md5.min.js") }}"></script>
  	<script src="{{ static_url("upyun/js/async.js") }}"></script>
  	<script src="{{ static_url("upyun/js/upyun-mu.js") }}"></script>

    <!-- customer js files -->
    <script src='{{ static_url("js/exif.js") }}' type="text/javascript"></script>
    <script src='{{ static_url("js/mobileBUGFix.mini.js") }}' type="text/javascript"></script>
    <script src='{{ static_url("js/json2.js") }}' type='text/javascript'></script>
    <script src="{{ static_url('js/vue-2.1.4.js') }}" type="text/javascript"></script>

    <script>
      new Vue({
        el: '#rst-itemcontent',
        data: {
          comments: [],
          comment_num: 0,
          limlt: 20
        },
        created: function() {
          this.queryComments(0, this.limlt);
        },
        methods: {
          sendLike: function() {
            console.log('like');
            $.ajax({
              type: "POST",
              url: "/api/articles/{{ article_info['_id'] }}/like",
              dataType: "json",
              contentType: 'application/json',
              success: function(data, status, xhr) {
                console.log(data);
                $("#like-icons").removeClass("fa-heart-o").addClass("fa-heart");
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
                if (XMLHttpRequest.status == 200) {
                  $("#like-icons").removeClass("fa-heart-o").addClass("fa-heart");
                }
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },
          sendComment: function() {
            var _self = this;
            var comment = $("#comment").val();
            console.log(comment);
            var data = {
              "comment": comment,
            };
            var json = JSON.stringify(data);
            console.log(json);

            $.ajax({
              type: "POST",
              url: "/api/articles/{{ article_info['_id'] }}/comment",
              dataType: "json",
              data: json,
              contentType: 'application/json',
              success: function(data, status, xhr) {
                console.log(data);
                $("#comment").val("");
                _self.queryNewComment();
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
                if (XMLHttpRequest.status == 200) {
                  $("#comment").val("");
                  _self.queryNewComment();
                }
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },

          loadMore: function() {
            var _self = this;
            $("#loadMoreBtn").text('Loading...');
            _self.queryComments(_self.comment_num, _self.limlt);
            setTimeout(function(){
              if (_self.comment_num % _self.limlt == 0){
                $("#loadMoreBtn").text('More comments');
              } else {
                $("#loadMoreBtn").css('display','none');
              }
            }, 1000);
            // setTimeout(function(){
            //   $("#loadMoreBtn").css('display','none');
            // }, 1000);
          },
          queryComments: function(idx, limit) {
            var _self = this;
            $.ajax({
              type: "GET",
              url: "/api/articles/{{ article_info['_id'] }}/comment?idx=" + idx + "&limit=" + limit,
              async: false,
              dataType: "json",
              contentType: 'application/json',
              success: function(datas, status, xhr) {
                console.log(datas);
                for(var i = 0, l = datas.length; i < l; i++) {
                  _self.comments.push(datas[i]);
                  _self.comment_num += 1;
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },
          queryNewComment: function() {
            var _self = this;
            $.ajax({
              type: "GET",
              url: "/api/articles/{{ article_info['_id'] }}/comment?idx=0&limit=1",
              async: false,
              dataType: "json",
              contentType: 'application/json',
              success: function(datas, status, xhr) {
                console.log(datas);
                for(var i = 0, l = datas.length; i < l; i++) {
                  _self.comments.splice(0, 0, datas[i]);
                  _self.comment_num += 1;
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
              },
              complete: function(XMLHttpRequest, textStatus) {
                this; // 调用本次AJAX请求时传递的options参数
              }
            });
          },
        }
      });
    </script>

  </body>
</html>
